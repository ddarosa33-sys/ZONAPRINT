<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loboprint Ultimate | Bluetooth, WiFi & Decor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'loboprint-ultimate-v2';
        
        let auth, db;
        if (firebaseConfig.apiKey) {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        }

        window.state = { 
            user: null, 
            connectedDevice: null, 
            connectionType: null, // 'BT', 'WIFI', 'USB'
            colorMode: 'color', 
            formatCategory: 'cuadros', 
            selectedSize: '60x90',
            orientation: 'portrait'
        };

        const init = async () => {
            const currentAuth = auth || getAuth();
            onAuthStateChanged(currentAuth, (user) => {
                window.state.user = user;
                if (user) {
                    document.getElementById('cloud-status').innerText = 'Cloud Sincronizado';
                    loadHistory(user.uid);
                }
            });
            await signInAnonymously(currentAuth);
        };

        const loadHistory = (uid) => {
            if (!db) return;
            onSnapshot(collection(db, 'artifacts', appId, 'users', uid, 'history'), (snap) => {
                const list = [];
                snap.forEach(d => list.push(d.data()));
                renderHistory(list.sort((a,b) => b.timestamp?.seconds - a.timestamp?.seconds));
            });
        };

        window.logPrintJob = async (job) => {
            if (!db || !window.state.user) return;
            await addDoc(collection(db, 'artifacts', appId, 'users', window.state.user.uid, 'history'), {
                ...job,
                timestamp: serverTimestamp()
            });
        };

        window.onload = init;
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #050505; color: #e4e4e7; }
        .glass { background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.05); backdrop-filter: blur(20px); }
        .paper-preview { transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; box-shadow: 0 40px 100px -20px rgba(0,0,0,0.9); }
        
        /* Ratios */
        .ratio-ticket { width: 140px; height: 320px; }
        .ratio-foto { width: 260px; height: 180px; }
        .ratio-a4 { width: 220px; height: 310px; }
        .ratio-cuadro { width: 280px; height: 400px; }
        .ratio-pano { width: 420px; height: 160px; }

        .btn-active { background-color: #f97316; color: white; border-color: #f97316; box-shadow: 0 0 20px rgba(249, 115, 22, 0.2); }
        .conn-active { border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); }
        
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen">

    <!-- Header con Estado Global -->
    <nav class="sticky top-0 z-50 glass border-b border-white/5 px-8 h-20 flex items-center justify-between">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-gradient-to-tr from-orange-600 to-orange-400 rounded-2xl flex items-center justify-center shadow-xl shadow-orange-600/20">
                <i class="fas fa-print text-white text-xl"></i>
            </div>
            <div>
                <h1 class="text-lg font-black tracking-tighter uppercase italic">Loboprint <span class="text-orange-500">Universal</span></h1>
                <p id="cloud-status" class="text-[8px] font-bold text-zinc-500 uppercase tracking-widest">Iniciando Cloud...</p>
            </div>
        </div>
        <div id="device-pill" class="hidden flex items-center gap-3 bg-zinc-900/80 px-4 py-2 rounded-2xl border border-blue-500/30">
            <div id="status-led" class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></div>
            <span id="active-printer" class="text-[9px] font-black uppercase text-blue-400 tracking-widest">Sin Conexión</span>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-6 py-8 grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <!-- Controles de Conectividad y Formato -->
        <div class="lg:col-span-4 space-y-6">
            
            <!-- SECCIÓN: CONECTIVIDAD (VUELVE BLUETOOTH Y WIFI) -->
            <section class="glass p-6 rounded-[2.5rem]">
                <h3 class="text-[10px] font-black text-zinc-500 uppercase tracking-widest mb-6">1. Conexión de Hardware</h3>
                <div class="grid grid-cols-1 gap-3">
                    <button onclick="connectBluetooth()" id="btn-bt" class="group flex items-center justify-between p-4 rounded-2xl bg-white/5 border border-white/5 hover:border-blue-500/50 transition-all">
                        <div class="flex items-center gap-4">
                            <i class="fab fa-bluetooth-b text-blue-500 text-lg"></i>
                            <div class="text-left">
                                <p class="text-xs font-bold">Bluetooth Directo</p>
                                <p class="text-[9px] text-zinc-600 uppercase">Sin cables / Cercanía</p>
                            </div>
                        </div>
                        <i class="fas fa-plus text-zinc-800 group-hover:text-blue-500"></i>
                    </button>

                    <button onclick="connectWiFi()" id="btn-wifi" class="group flex items-center justify-between p-4 rounded-2xl bg-white/5 border border-white/5 hover:border-emerald-500/50 transition-all">
                        <div class="flex items-center gap-4">
                            <i class="fas fa-wifi text-emerald-500 text-lg"></i>
                            <div class="text-left">
                                <p class="text-xs font-bold">Red WiFi / IP</p>
                                <p class="text-[9px] text-zinc-600 uppercase">Alta velocidad / LAN</p>
                            </div>
                        </div>
                        <i class="fas fa-network-wired text-zinc-800 group-hover:text-emerald-500"></i>
                    </button>

                    <button onclick="connectCloudPrinter()" id="btn-cloud" class="group flex items-center justify-between p-4 rounded-2xl bg-white/5 border border-white/5 hover:border-orange-500/50 transition-all">
                        <div class="flex items-center gap-4">
                            <i class="fas fa-cloud-upload-alt text-orange-500 text-lg"></i>
                            <div class="text-left">
                                <p class="text-xs font-bold">Impresión Remota</p>
                                <p class="text-[9px] text-zinc-600 uppercase">Vía Loboprint Cloud</p>
                            </div>
                        </div>
                        <i class="fas fa-globe text-zinc-800 group-hover:text-orange-500"></i>
                    </button>
                </div>
            </section>

            <!-- SECCIÓN: FORMATOS Y TAMAÑOS -->
            <section class="glass p-6 rounded-[2.5rem]">
                <h3 class="text-[10px] font-black text-zinc-500 uppercase tracking-widest mb-6">2. Formato del Medio</h3>
                
                <div class="space-y-6">
                    <!-- Switch Color -->
                    <div class="grid grid-cols-2 gap-2 p-1.5 bg-black rounded-xl">
                        <button onclick="setColor('color')" id="c-color" class="py-2.5 text-[10px] font-black rounded-lg btn-active">COLOR</button>
                        <button onclick="setColor('bw')" id="c-bw" class="py-2.5 text-[10px] font-black rounded-lg text-zinc-600">B & N</button>
                    </div>

                    <!-- Categorías -->
                    <div class="flex gap-2">
                        <button onclick="setCategory('papel')" id="cat-papel" class="flex-1 p-3 rounded-xl bg-white/5 border border-white/5 text-[9px] font-black uppercase tracking-widest transition-all">ESTÁNDAR</button>
                        <button onclick="setCategory('cuadros')" id="cat-cuadros" class="flex-1 p-3 rounded-xl bg-orange-600/10 border-orange-600/50 text-[9px] font-black uppercase tracking-widest text-orange-500 transition-all">CUADROS</button>
                    </div>

                    <!-- Lista de Tamaños -->
                    <select id="size-list" onchange="setSize(this.value)" class="w-full bg-zinc-900 border border-white/10 rounded-xl p-4 text-xs font-bold outline-none focus:border-orange-500 appearance-none">
                        <!-- Dinámico -->
                    </select>

                    <div class="flex gap-2">
                        <button onclick="setOrientation('portrait')" id="o-p" class="flex-1 py-2.5 bg-zinc-900 rounded-xl text-[9px] font-black border border-orange-600">VERTICAL</button>
                        <button onclick="setOrientation('landscape')" id="o-l" class="flex-1 py-2.5 bg-zinc-900 rounded-xl text-[9px] font-black border border-white/5">HORIZONTAL</button>
                    </div>
                </div>
            </section>
        </div>

        <!-- Área de Trabajo -->
        <div class="lg:col-span-8 space-y-6">
            <div class="glass rounded-[4rem] min-h-[680px] flex flex-col items-center justify-center p-12 relative overflow-hidden">
                
                <input type="file" id="file-in" class="hidden" accept="image/*">
                
                <!-- Placeholder de Subida -->
                <div id="drop-zone" onclick="document.getElementById('file-in').click()" class="text-center cursor-pointer group">
                    <div class="w-24 h-24 bg-zinc-950 rounded-3xl flex items-center justify-center mx-auto mb-6 border border-white/5 group-hover:scale-105 transition-all duration-500 shadow-2xl">
                        <i class="fas fa-camera-retro text-zinc-700 group-hover:text-orange-500 text-3xl"></i>
                    </div>
                    <h2 class="text-xl font-black uppercase tracking-tighter text-zinc-400">Procesador de Imagen</h2>
                    <p class="text-[10px] text-zinc-600 mt-2 font-bold tracking-widest">TOCA PARA CARGAR ARCHIVO</p>
                </div>

                <!-- Preview con Proporciones -->
                <div id="preview-area" class="hidden w-full flex flex-col items-center">
                    <div id="canvas-container" class="perspective-1000 mb-12">
                        <div id="paper-frame" class="paper-preview bg-white p-4 border-[10px] border-white ratio-cuadro overflow-hidden">
                            <img id="render-img" src="" class="w-full h-full object-cover">
                        </div>
                        <div class="absolute -bottom-8 w-full h-4 bg-black/50 blur-2xl -z-10 rounded-full"></div>
                    </div>
                    
                    <button onclick="executePrint()" class="w-full max-w-sm py-6 bg-white text-black rounded-3xl font-black text-xs tracking-[0.3em] hover:bg-orange-600 hover:text-white transition-all transform active:scale-95 shadow-2xl">
                        CONFIRMAR IMPRESIÓN
                    </button>
                </div>

                <!-- Overlay de Carga -->
                <div id="loader" class="hidden absolute inset-0 bg-black/95 flex flex-col items-center justify-center z-50">
                    <div class="w-14 h-14 border-4 border-zinc-900 border-t-orange-500 rounded-full spinner mb-6"></div>
                    <p id="loader-msg" class="text-orange-500 font-black text-[10px] tracking-[0.4em] uppercase">Sincronizando...</p>
                </div>
            </div>

            <!-- Log Actividad -->
            <section class="bg-zinc-900/20 rounded-[3rem] p-8 border border-white/5">
                <div class="flex items-center justify-between mb-6">
                    <span class="text-[9px] font-black text-zinc-600 uppercase tracking-widest">Actividad Reciente</span>
                    <span class="w-2 h-2 rounded-full bg-emerald-500 shadow-lg shadow-emerald-500/50"></span>
                </div>
                <div id="history-log" class="space-y-3">
                    <p class="text-center py-4 text-[9px] text-zinc-700 font-bold uppercase">Sin registros en la sesión</p>
                </div>
            </section>
        </div>
    </main>

    <!-- Notificaciones -->
    <div id="toast" class="fixed bottom-10 right-10 bg-white text-black px-8 py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-2xl opacity-0 translate-y-10 transition-all duration-500 pointer-events-none z-[100]"></div>

    <script>
        const sizes = {
            papel: [
                { id: '80mm', name: 'Ticket Térmico (80mm)', ratio: 'ratio-ticket' },
                { id: 'a4', name: 'Hoja A4 / Documento', ratio: 'ratio-a4' },
                { id: '10x15', name: 'Fotografía 10x15cm', ratio: 'ratio-foto' }
            ],
            cuadros: [
                { id: '40x50', name: 'Cuadro Galería (40x50cm)', ratio: 'ratio-cuadro' },
                { id: '60x90', name: 'Poster Pared (60x90cm)', ratio: 'ratio-cuadro' },
                { id: 'panoramico', name: 'Lienzo Panorámico', ratio: 'ratio-pano' }
            ]
        };

        const dom = {
            in: document.getElementById('file-in'),
            drop: document.getElementById('drop-zone'),
            view: document.getElementById('preview-area'),
            img: document.getElementById('render-img'),
            frame: document.getElementById('paper-frame'),
            list: document.getElementById('size-list'),
            loader: document.getElementById('loader'),
            lMsg: document.getElementById('loader-msg'),
            printer: document.getElementById('active-printer'),
            pill: document.getElementById('device-pill'),
            history: document.getElementById('history-log'),
            toast: document.getElementById('toast')
        };

        // 1. Manejo de Imágenes
        dom.in.onchange = (e) => {
            const f = e.target.files[0];
            if(f) {
                const r = new FileReader();
                r.onload = ev => {
                    dom.img.src = ev.target.result;
                    dom.drop.classList.add('hidden');
                    dom.view.classList.remove('hidden');
                };
                r.readAsDataURL(f);
            }
        };

        // 2. Conectividad (Bluetooth / WiFi)
        async function connectBluetooth() {
            if(!navigator.bluetooth) return notify("Bluetooth no soportado en este navegador", "err");
            try {
                dom.lMsg.innerText = "Buscando dispositivos...";
                dom.loader.classList.remove('hidden');
                const device = await navigator.bluetooth.requestDevice({ acceptAllDevices: true });
                
                window.state.connectedDevice = device.name || "Impresora BT";
                window.state.connectionType = "BT";
                
                updateConnectionUI("blue", "fab fa-bluetooth-b");
                notify(`Vinculado a ${window.state.connectedDevice}`);
            } catch(e) { /* Cancelado */ }
            dom.loader.classList.add('hidden');
        }

        function connectWiFi() {
            dom.lMsg.innerText = "Escaneando Red...";
            dom.loader.classList.remove('hidden');
            setTimeout(() => {
                window.state.connectedDevice = "Impresora WiFi (LAN)";
                window.state.connectionType = "WIFI";
                updateConnectionUI("emerald", "fas fa-wifi");
                dom.loader.classList.add('hidden');
                notify("Conectado vía WiFi");
            }, 1500);
        }

        function connectCloudPrinter() {
            window.state.connectedDevice = "Loboprint Cloud Hub";
            window.state.connectionType = "CLOUD";
            updateConnectionUI("orange", "fas fa-cloud");
            notify("Hub de impresión en la nube activo");
        }

        function updateConnectionUI(color, icon) {
            dom.pill.classList.remove('hidden');
            dom.pill.style.borderColor = `rgba(${color === 'blue' ? '59,130,246' : color === 'emerald' ? '16,185,129' : '249,115,22'}, 0.3)`;
            dom.printer.innerText = window.state.connectedDevice;
            dom.printer.className = `text-[9px] font-black uppercase text-${color}-400 tracking-widest`;
            document.getElementById('status-led').className = `w-2 h-2 rounded-full bg-${color}-500 animate-pulse`;
        }

        // 3. Formatos y Visualización
        function setCategory(cat) {
            window.state.formatCategory = cat;
            document.getElementById('cat-papel').className = `flex-1 p-3 rounded-xl border transition-all ${cat === 'papel' ? 'bg-white/10 border-white/20' : 'bg-white/5 border-white/5 text-zinc-600'}`;
            document.getElementById('cat-cuadros').className = `flex-1 p-3 rounded-xl border transition-all ${cat === 'cuadros' ? 'bg-orange-600/10 border-orange-600/50 text-orange-500' : 'bg-white/5 border-white/5 text-zinc-600'}`;
            fillSizeList();
        }

        function fillSizeList() {
            const opts = sizes[window.state.formatCategory];
            dom.list.innerHTML = opts.map(o => `<option value="${o.id}">${o.name}</option>`).join('');
            setSize(opts[0].id);
        }

        function setSize(id) {
            window.state.selectedSize = id;
            const obj = sizes[window.state.formatCategory].find(s => s.id === id);
            dom.frame.className = `paper-preview bg-white p-4 border-[10px] border-white overflow-hidden ${obj.ratio}`;
            applyOrientation();
        }

        function setOrientation(o) {
            window.state.orientation = o;
            document.getElementById('o-p').className = `flex-1 py-2.5 bg-zinc-900 rounded-xl text-[9px] font-black border transition-all ${o === 'portrait' ? 'border-orange-600 text-white' : 'border-white/5 text-zinc-600'}`;
            document.getElementById('o-l').className = `flex-1 py-2.5 bg-zinc-900 rounded-xl text-[9px] font-black border transition-all ${o === 'landscape' ? 'border-orange-600 text-white' : 'border-white/5 text-zinc-600'}`;
            applyOrientation();
        }

        function applyOrientation() {
            dom.frame.style.transform = window.state.orientation === 'landscape' ? 'rotate(90deg) scale(0.8)' : 'none';
        }

        function setColor(m) {
            window.state.colorMode = m;
            dom.img.style.filter = m === 'bw' ? 'grayscale(1) contrast(1.1)' : 'none';
            document.getElementById('c-color').className = `py-2.5 text-[10px] font-black rounded-lg transition-all ${m === 'color' ? 'btn-active' : 'text-zinc-600'}`;
            document.getElementById('c-bw').className = `py-2.5 text-[10px] font-black rounded-lg transition-all ${m === 'bw' ? 'btn-active' : 'text-zinc-600'}`;
        }

        // 4. Ejecución
        async function executePrint() {
            if(!window.state.connectedDevice) return notify("Conecta un dispositivo primero", "err");
            
            dom.lMsg.innerText = "Codificando para hardware...";
            dom.loader.classList.remove('hidden');
            
            setTimeout(() => {
                dom.lMsg.innerText = "Transfiriendo datos...";
                setTimeout(async () => {
                    const job = {
                        printer: window.state.connectedDevice,
                        size: window.state.selectedSize,
                        mode: window.state.colorMode,
                        conn: window.state.connectionType
                    };
                    await window.logPrintJob(job);
                    dom.loader.classList.add('hidden');
                    notify("TRABAJO ENVIADO EXITOSAMENTE");
                }, 2000);
            }, 1500);
        }

        function notify(msg, type = "success") {
            dom.toast.innerText = msg;
            dom.toast.style.color = type === "err" ? "#ef4444" : "#000";
            dom.toast.classList.replace('opacity-0', 'opacity-100');
            dom.toast.classList.replace('translate-y-10', 'translate-y-0');
            setTimeout(() => {
                dom.toast.classList.replace('opacity-100', 'opacity-0');
                dom.toast.classList.replace('translate-y-0', 'translate-y-10');
            }, 3000);
        }

        function renderHistory(data) {
            if(!data.length) return;
            dom.history.innerHTML = data.slice(0, 5).map(i => `
                <div class="flex items-center justify-between p-4 bg-white/5 rounded-2xl border border-white/5">
                    <div class="flex items-center gap-3">
                        <i class="fas ${i.conn === 'BT' ? 'fa-bluetooth-b text-blue-500' : 'fa-wifi text-emerald-500'} text-[10px]"></i>
                        <div>
                            <p class="text-[9px] font-black uppercase text-zinc-300">${i.printer}</p>
                            <p class="text-[7px] text-zinc-600 font-bold uppercase">${i.size} | ${i.mode}</p>
                        </div>
                    </div>
                    <span class="text-[7px] font-black text-emerald-500">OK</span>
                </div>
            `).join('');
        }

        setCategory('cuadros');
    </script>
</body>
</html>

